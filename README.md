/// Universidad del Valle de Guatemala 
/// Proyecto 1: Reloj
/// Autor: Dulce Salguero - 231208
/// PROGRA. DE MICROCONTROLADORES - 10
 
.include "M328PDEF.inc"
.cseg 

/// DEFINIMOS 
.def contar500ms = R18
.def contar1s = R19
.def estado = R20
.def valordez = R27
.def Usegund = R21
.def Dsegund = R22
.def Umin = R23
.def Dmin = R24
.def Uhora = R26
.def Dhora = R26
.def Udia = R0
.def Ddia = R1
.def Umes = R2
.def Dmes = R3
.def UAmin = R4
.def DAmin = R5
.def UAhora = R6 
.def DAhora = R7

.org 0x00
	JMP MAIN     /// vector principal

.org 0x0006
	JMP ISR_PCINT0		/// vector de la interrupcion

/////////// MAIN //////////////////
MAIN: 
;stack 
	LDI R16, LOW (RAMEND) 
	OUT SPL, R16 
	LDI R17, HIGH(RAMEND) 
	OUT SPH, R17

/////////// DISPLAY: LISTA DE VALORES ///////
TABLE:
	.DB  0x3F,0x06,0x5B,0x4F,0x66,0x6D,0x7D,0x07,0x7F,0x6F ;0x77,0x39,0x71,0x76,0x37,0x06

/////////// SETUP ////////////////
SETUP:	
	
;INPUTS
	SBI PORTB, PB0
	CBI DDRB, PB0
	SBI PORTB, PB1
	CBI DDRB, PB1
	SBI PORTB, PB2
	CBI DDRB, PB2

;OUTPUT
	LDI R16, 0xFF		
	OUT DDRC, R16
	SBI DDRB, PB4		
	CBI PORTB, PB4
	
	SBI DDRB, PB3		
	CBI PORTB, PB3
	
	SBI DDRB, PB5		; alarma
	CBI PORTB, PB5

;OUTPUT TRANSISTORES
	LDI R16, 0xFF
	OUT DDRD, R16

	CALL Init_T0		; se inicializa Timer0

/////// INTERRUPCIONES POR PULSADORES ///////

	LDI R16, (1 << PCINT2)|(1 << PCINT1)|(1 << PCINT0)
	STS PCMSK0, R16		; habilitar

	LDI R16, (1 << PCIE0)
	STS PCICR, R16		; habilitar

	SEI					; habilitar interrupciones globales
	
	CLR R27				; valor que obtendrá de la lista 
	LDI ZH, HIGH(T7S << 1)
	LDI ZL, LOW(T7S << 1)
	ADD ZL, R27
	LPM R27, Z

;valores iniciales
	CLR cont500ms
	CLR cont1s
	LDI estado, 0
	
	LDI R28, 0b1000_0000
	MOV R8, R28

	CLR R28

;hora
	LDI R26, 0
	LDI Uhora, 0
	LDI Dmin, 0 
	LDI Umin, 0
	LDI Dsegund, 0
	LDI Usegund, 0

;fecha
	LDI R28, 0
	MOV Ddia, R28
	LDI R28, 1
	MOV Udia, R28
	
	LDI R28, 0
	MOV Dmes, R28
	LDI R28, 1
	MOV Umes, R28

;alarma
	LDI R28, 0
	MOV DAhora, R28
	LDI R28, 0
	MOV UAhora, R28

	LDI R28, 0
	MOV DAmin, R28
	LDI R28, 0
	MOV UAmin, R28

	LDI R29, 0			; ON/OFF alarma

//////// LOOP ////////////////////////////////

LOOP:
	;call TEST_DISPLAY
	;call TEST_LISTA_DISPLAY
	SBRS estado, 0		
	JMP ESTADO_XXX0	
	JMP ESTADO_XXX1		
	
	RJMP PULSO

////////////// PULSO /////////////////
PULSO:
	CPI cont500ms, 50
	BRNE LOOP
	CLR cont500ms

; DOS PUNTOS
	SBRC R8, 7
	SBI PINB, PB3
	SBRS R8, 7
	CBI PORTB, PB3

	INC cont1s
	CPI cont1s, 2
	BRNE LOOP
	CLR cont1s

; segundos
	LDI R28, 9
	CPSE Usegund, R28
	CALL INC_USEG
	CLR Usegund

	LDI R28, 5
	CPSE Dsegund, R28
	CALL INC_DSEG
	CLR Dsegund

; minutos
	LDI R28, 9
	CPSE Umin, R28
	CALL INC_UMIN
	CLR Umin

	LDI R28, 5
	CPSE Dmin, R28
	CALL INC_DMIN
	CLR Dmin

; horas
	LDI R28, 9
	CPSE Uhora, R28
	CALL INC_UHOR
	CLR Uhora

	LDI R28, 2
	CPSE R26, R28
	CALL INC_DHOR
	CLR R26

	RJMP LOOP	

///////////// DEFINIR ESTADOS ///////////

ESTADO_XXX0:
	SBRS estado, 1
	JMP ESTADO_XX00
	JMP ESTADO_XX10

ESTADO_XX00:
	SBRS estado, 2
	JMP ESTADO_X000
	JMP ESTADO_X100

ESTADO_X000:
	SBRS estado, 3
	JMP ESTADO_0000
	JMP ESTADO_1000

ESTADO_XXX1:
	SBRS estado, 1
	JMP ESTADO_XX01
	JMP ESTADO_XX11

ESTADO_XX01:
	SBRS estado, 2
	JMP ESTADO_X001
	JMP ESTADO_X101

ESTADO_X001:
	SBRS estado, 3
	JMP ESTADO_0001
	JMP ESTADO_1001

ESTADO_XX10:
	SBRS estado, 2
	JMP ESTADO_X010
	JMP ESTADO_X110

ESTADO_X010:
	SBRS estado, 3
	JMP ESTADO_0010
	JMP	ESTADO_1010

ESTADO_XX11:
	SBRS estado, 2
	JMP	ESTADO_X011
	JMP ESTADO_X111
	
ESTADO_X011:
	SBRS estado, 3
	JMP ESTADO_0011
	JMP ESTADO_1011

ESTADO_X100:
	SBRS estado, 3
	JMP ESTADO_0100
	JMP LOOP
	;jmp ESTADO_1100

ESTADO_X101:
	SBRS estado, 3
	JMP ESTADO_0101
	;jmp ESTADO_1101

ESTADO_X110:
	SBRS estado, 3
	JMP ESTADO_0110
	;jmp ESTADO_1110

ESTADO_X111:
	SBRS estado, 3
	JMP ESTADO_0111
	;jmp ESTADO_1111

/////////// ESTADOS //////////// 0000                             
ESTADO_0000:
	LDI R28, 0b1000_0000
	MOV R8, R28
	;ldi useg, 0
	CALL USEG_DISPLAY
	CALL DSEG_DISPLAY
	CALL UMIN_DISPLAY
	CALL DMIN_DISPLAY
	CALL UHOR_DISPLAY
	CALL DHOR_DISPLAY

	SBRS R29, 0
	CBI PORTB, PB5
	SBRC R29, 0
	CALL ALARMA

	RJMP PULSO
	JMP LOOP

;0001
ESTADO_0001:
	CLR R8
	CALL UDIA_DISPLAY
	CALL DDIA_DISPLAY
	CALL UMES_DISPLAY
	CALL DMES_DISPLAY
	RJMP PULSO
	JMP LOOP

;0010
ESTADO_0010:
	SBI PORTB, PB3
	CALL UAMIN_DISPLAY
	CALL DAMIN_DISPLAY
	CALL UAHOR_DISPLAY
	CALL DAHOR_DISPLAY
	SBRS R29, 0
	CALL ALARMA_OFF_DISPLAY
	SBRC R29, 0
	CALL ALARMA_ON_DISPLAY
	CLR R8
	RJMP PULSO
	JMP LOOP

;0011
ESTADO_0011:
	CLR R8
	CALL UHOR_DISPLAY
	CALL DHOR_DISPLAY
	CALL H_DISPLAY
	RJMP PULSO
	JMP LOOP

;0100
ESTADO_0100:
	LDI R28, 12
	CALL UDIA_DISPLAY
	CALL DDIA_DISPLAY
	CALL F_DISPLAY
	RJMP PULSO
	JMP LOOP

;0101                                     
ESTADO_0101:
	CALL UAHOR_DISPLAY
	CALL DAHOR_DISPLAY
	CALL A_DISPLAY
	RJMP PULSO
	JMP LOOP

;0110                                     
ESTADO_0110:
	CLR R8
	CALL UMIN_DISPLAY
	CALL DMIN_DISPLAY
	CALL H_DISPLAY
	RJMP PULSO
	JMP LOOP

;0111
ESTADO_0111:
	CALL UMES_DISPLAY
	CALL DMES_DISPLAY
	CALL F_DISPLAY
	RJMP PULSO
	JMP LOOP

;1000
ESTADO_1000:
	CALL UAMIN_DISPLAY
	CALL DAMIN_DISPLAY
	CALL A_DISPLAY
	RJMP PULSO
	JMP LOOP

;1001
ESTADO_1001:
	LDI R29, 0
	CALL O_DISPLAY
	CALL F_DISPLAY
	RJMP PULSO
	JMP LOOP

;1010
ESTADO_1010:
	LDI R29, 1
	CALL O_DISPLAY
	CALL N_DISPLAY
	JMP LOOP

;1011
ESTADO_1011:
	CLR R8
	SBI PORTB, PB3
	SBI PORTB, PB5
	CALL UMIN_DISPLAY
	CALL DMIN_DISPLAY
	CALL UHOR_DISPLAY
	CALL DHOR_DISPLAY
	CALL A_DISPLAY
	RJMP PULSO
	JMP LOOP

/////// ON: ALARMA //////////////////
ALARMA_ON_DISPLAY:
	CALL O_DISPLAY
	CALL N_DISPLAY
	
	RET

//////// OFF: ALARMA ///////////////
ALARMA_OFF_DISPLAY:
	CALL O_DISPLAY
	CALL F_DISPLAY
	
	RET

//////// COMPARACIÓN: ALARMA /////////
ALARMA:
	CPSE DAhora, R26
	RET
	CPSE UAhora, Uhora
	RET
	CPSE DAmin, Dmin
	RET
	CPSE UAmin, Umin
	RET
	LDI estado, 11
	RET
	
//////// TIMER0 ///////////////
INIT_TIMER0: 
	LDI R16, (1 << CS02)|(1 << CS00)	;prescaler 1024
	OUT TCCR0B, R16
	LDI R16, 99

	OUT TCNT0, R16						; valor inicial contador
	LDI R16, (1 << TOIE0)
	STS TIMSK0, R16
	RET

//////// OVERFLOW TIMER0 //////////
ISR_OVFTIMER0: 
	;push R17				; guardar en pila R16
	;in R17, sreg
	;push R17				; guardar en pila SREG

	LDI R17, 99				; cargar el valor de desbordamiento
	OUT TCNT0, R17			; cargar valor inicial
	SBI TIFR0, TOV0			; borrar bandra TOV0
	INC cont500ms					; incrementar contador 10 ms

	;pop R17					; obtener SREG
	;out sreg, R17			; restaurar valor antiguo SREG
	;pop R17					; obtener valor R16
	RETI 

///////// PCINT0 /////////
ISR_PCINT0: 
	PUSH R16
	IN R16, SREG
	PUSH R16

	SBRS estado, 0		
	JMP ISR_ESTADO_XXX0		
	JMP ISR_ESTADO_XXX1		

//////// DEFINIENDO ESTADOS ISR /////////////
ISR_ESTADO_XXX0:
	SBRS estado, 1
	JMP ISR_ESTADO_XX00
	JMP ISR_ESTADO_XX10

ISR_ESTADO_XX00:
	SBRS estado, 2
	JMP ISR_ESTADO_X000
	JMP ISR_ESTADO_X100

ISR_ESTADO_X000:
	SBRS estado, 3
	JMP ISR_ESTADO_0000
	JMP ISR_ESTADO_1000

ISR_ESTADO_XXX1:
	SBRS estado, 1
	JMP ISR_ESTADO_XX01
	JMP ISR_ESTADO_XX11

ISR_ESTADO_XX01:
	SBRS estado, 2
	JMP ISR_ESTADO_X001
	JMP ISR_ESTADO_X101

ISR_ESTADO_X001:
	SBRS estado, 3
	JMP ISR_ESTADO_0001
	JMP ISR_ESTADO_1001

ISR_ESTADO_XX10:
	SBRS estado, 2
	JMP ISR_ESTADO_X010
	JMP ISR_ESTADO_X110

ISR_ESTADO_X010:
	SBRS estado, 3
	JMP ISR_ESTADO_0010
	JMP	ISR_ESTADO_1010

ISR_ESTADO_XX11:
	SBRS estado, 2
	JMP	ISR_ESTADO_X011
	JMP ISR_ESTADO_X111

ISR_ESTADO_X011:
	SBRS estado, 3
	JMP ISR_ESTADO_0011
	JMP ISR_ESTADO_1011

ISR_ESTADO_X100:
	SBRS estado, 3
	JMP ISR_ESTADO_0100
	JMP ISR_POP_PCINT0
	;jmp ESTADO_1100

ISR_ESTADO_X101:
	SBRS estado, 3
	JMP ISR_ESTADO_0101
	JMP ISR_POP_PCINT0
	;jmp ESTADO_1101

ISR_ESTADO_X110:
	SBRS estado, 3
	JMP ISR_ESTADO_0110
	JMP ISR_POP_PCINT0
	;jmp ESTADO_1110

ISR_ESTADO_X111:
	SBRS estado, 3
	JMP ISR_ESTADO_0111
	JMP ISR_POP_PCINT0
	;jmp ESTADO_1111

///////////// ESTADOS ISR  //////////
;0000
ISR_ESTADO_0000:
	IN R16, PINB
	SBRS R16, PB0
	LDI estado, 1			; PB0 = 0
	IN R16, PINB
	SBRS R16, PB1
	LDI estado, 2			; PB1 = 0
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 3			; PB2 = 0
	JMP ISR_POP_PCINT0

;0001
ISR_ESTADO_0001:
	IN R16, PINB
	SBRS R16, PB0
	LDI estado, 0			; PB0 = 0
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 7
	JMP ISR_POP_PCINT0

;0010
ISR_ESTADO_0010:
	IN R16, PINB
	SBRS R16, PB2			; PB2
	LDI estado, 5
	IN R16, PINB
	SBRS R16, PB1
	LDI estado, 0			; PB1 = 0
	JMP ISR_POP_PCINT0

;0011
ISR_ESTADO_0011:
	IN R16, PINB
	SBRS R16, PB0
	JMP ISR_INC_UHOR			; PB0 = 0
	IN R16, PINB
	SBRS R16, PB1
	JMP ISR_DEC_UHOR			; PB1 = 0
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 6			; PB2 = 0
	JMP ISR_POP_PCINT0

;0100
ISR_ESTADO_0100:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 1			; PB2 = 0
	IN R16, PINB
	SBRS R16, PB0
	JMP ISR_INC_UDIA
	IN R16, PINB
	SBRS R16, PB1
	JMP ISR_DEC_DIA
	JMP ISR_POP_PCINT0

;0101
ISR_ESTADO_0101:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 8
	IN R16, PINB
	SBRS R16, PB0
	JMP ISR_INC_A_UHOR
	IN R16, PINB
	SBRS R16, PB1
	JMP ISR_DEC_A_UHOR
	JMP ISR_POP_PCINT0

;0110
ISR_ESTADO_0110:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 0			; PB2 = 0
	IN R16, PINB
	SBRS R16, PB0
	JMP ISR_INC_UMIN
	IN R16, PINB
	SBRS R16, PB1
	JMP ISR_DEC_UMIN
	JMP ISR_POP_PCINT0

;0111
ISR_ESTADO_0111:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 4			; PB2 = 0
	IN R16, PINB
	SBRS R16, PB0
	JMP ISR_INC_UMES
	IN R16, PINB
	SBRS R16, PB1
	JMP ISR_DEC_UMES
	JMP ISR_POP_PCINT0

;1000
ISR_ESTADO_1000:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 9
	IN R16, PINB
	SBRS R16, PB0
	JMP ISR_INC_A_UMIN
	IN R16, PINB
	SBRS R16, PB1
	JMP ISR_DEC_A_UMIN
	JMP ISR_POP_PCINT0

;1001
ISR_ESTADO_1001:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 2
	IN R16, PINB
	SBRS R16, PB0
	LDI estado, 10
	JMP ISR_POP_PCINT0

;1010
ISR_ESTADO_1010:
	IN R16, PINB
	SBRS R16, PB2
	LDI estado, 2
	IN R16, PINB
	SBRS R16, PB1
	LDI estado, 9
	JMP ISR_POP_PCINT0

;1011
ISR_ESTADO_1011:
	IN R16, PINB
	SBRS R16, PB2
	JMP ISR_ESTADO_1011_2
	JMP ISR_POP_PCINT0

ISR_ESTADO_1011_2:
	LDI R29, 0
	LDI estado, 0
	CBI PORTB, PB5
	JMP ISR_POP_PCINT0

/////////////// ISR POP PCINT0 ////////////////////////
ISR_POP_PCINT0:
	SBI PCIFR, PCIF0

	POP R16
	OUT SREG, R16
	POP R16
	RETI

///////// DISPLAY [RELOJ] /////////////
TEST_DISPLAY:
	SBI PINC, PC0
	SBI PINC, PC1
	SBI PINC, PC2
	SBI PINC, PC3
	SBI PINC, PC4
	SBI PINC, PC5
	SBI PINB, PB4
	;sbi PORTB, PB3
	;sbi PINB, PB5

	SBI PIND, PD2
	SBI PIND, PD3
	SBI PIND, PD4
	SBI PIND, PD5
	SBI PIND, PD6
	SBI PIND, PD7
	
	RET

///////////// LISTA PARA EL DISPLAY /////////////
TEST_LISTA_DISPLAY:
	;ldi useg, 0 
	MOV R27, useg
	LDI ZH, HIGH(T7S << 1)
	LDI ZL, LOW(T7S << 1)
	ADD ZL, R27
	LPM R27, Z

	SBRC R27, PC6
	SBI PORTB, PB4
	SBRS R27, PC6
	CBI PORTB, PB4

	OUT PORTC, R27
	SBI PIND, PD7

	RET

///////////// USEG /////////////
USEG_DISPLAY:	
	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD5
	CBI PORTD, PD6
	

	MOV R27, useg
	LDI ZH, HIGH(T7S << 1)
	LDI ZL, LOW(T7S << 1)
	ADD ZL, R27
	LPM R27, Z

	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD5
	CBI PORTD, PD6

	SBRC R27, PC6
	SBI PORTB, PB4
	SBRS R27, PC6
	CBI PORTB, PB4

	OUT PORTC, R27
	SBI PORTD, PD7
	
	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD5
	CBI PORTD, PD6

	RET

//////////// DSEG ///////////
DSEG_DISPLAY:
	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD5
	CBI PORTD, PD7

	MOV R27, dseg
	LDI ZH, HIGH(T7S << 1)
	LDI ZL, LOW(T7S << 1)
	ADD ZL, R27
	LPM R27, Z

	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD5
	CBI PORTD, PD7

	SBRC R27, PC6
	SBI PORTB, PB4
	SBRS R27, PC6
	CBI PORTB, PB4

	OUT PORTC, R27
	SBI PORTD, PD6
	
	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD5
	CBI PORTD, PD7

	RET

///////////// MINUTOS DISPLAY ///////////////
UMIN_DISPLAY:
	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD6
	CBI PORTD, PD7

	MOV R27, umin
	LDI ZH, HIGH(T7S << 1)
	LDI ZL, LOW(T7S << 1)
	ADD ZL, R27
	LPM R27, Z

	CBI PORTD, PD2
	CBI PORTD, PD3
	CBI PORTD, PD4
	CBI PORTD, PD6
	CBI PORTD, PD7

	SBRC R27, PC6
	SBI PORTB, PB4
	SBRS R27, PC6
	CBI PORTB, PB4

	OUT PORTC, R27
